<% layout("/layouts/boilerplate") -%>
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <h2>Check-In for <%= event.title %></h2>
            <p class="text-muted">Event Date: <%= new Date(event.date).toLocaleString() %> | Venue: <%= event.venue %></p>
        </div>
    </div>
    
    <div class="row mt-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5>Manual Check-In</h5>
                </div>
                <div class="card-body">
                    <form id="checkInForm">
                        <div class="mb-3">
                            <label for="ticketToken" class="form-label">Enter Ticket Token:</label>
                            <input type="text" class="form-control" id="ticketToken" name="ticketToken" placeholder="Paste or type ticket token" required>
                        </div>
                        <button type="submit" class="btn btn-success">Check In</button>
                    </form>
                    
                    <div id="checkInMessage" class="mt-3"></div>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5>Attendance Summary</h5>
                </div>
                <div class="card-body">
                    <p><strong>Total Registrations:</strong> <%= event.registrations.length %></p>
                    <p><strong>Checked In:</strong> <span id="checkedInCount"><%= event.registrations.filter(r => r.attended).length %></span></p>
                    <p><strong>Not Checked In:</strong> <span id="notCheckedInCount"><%= event.registrations.filter(r => !r.attended).length %></span></p>
                    
                    <div class="progress mt-3">
                        <% const checkedInPercentage = event.registrations.length > 0 ? (event.registrations.filter(r => r.attended).length / event.registrations.length * 100) : 0 %>
                        <div class="progress-bar bg-success" role="progressbar" style="width: <%= checkedInPercentage %>%" id="attendanceProgress">
                            <%= Math.round(checkedInPercentage) %>%
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row mt-4">
        <div class="col-12">
            <h4>Registration List</h4>
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Ticket Token</th>
                            <th>Status</th>
                            <th>Check-In Time</th>
                        </tr>
                    </thead>
                    <tbody id="registrationList">
                        <% for(let reg of event.registrations) { %>
                            <tr data-token="<%= reg.ticketToken %>">
                                <td><%= reg.user.username %></td>
                                <td><%= reg.user.email %></td>
                                <td><code><%= reg.ticketToken.substring(0, 8) %>...</code></td>
                                <td>
                                    <% if (reg.attended) { %>
                                        <span class="badge bg-success">Checked In</span>
                                    <% } else { %>
                                        <span class="badge bg-secondary">Not Checked In</span>
                                    <% } %>
                                </td>
                                <td>
                                    <% if (reg.attended) { %>
                                        <%= new Date(reg.checkedInAt).toLocaleString() %>
                                    <% } else { %>
                                        -
                                    <% } %>
                                </td>
                            </tr>
                        <% } %>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <div class="row mt-3">
        <div class="col-12">
            <a href="/events/<%= event._id %>" class="btn btn-secondary">Back to Event</a>
        </div>
    </div>
</div>

<script>
document.getElementById('checkInForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const ticketToken = document.getElementById('ticketToken').value.trim();
    const messageDiv = document.getElementById('checkInMessage');
    
    try {
        const response = await fetch('/events/<%= event._id %>/checkin', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ ticketToken })
        });
        
        const data = await response.json();
        
        if (data.success) {
            messageDiv.innerHTML = `<div class="alert alert-success"><strong>Success!</strong> ${data.attendee} has been checked in.</div>`;
            
            const row = document.querySelector(`tr[data-token="${ticketToken}"]`);
            if (row) {
                row.cells[3].innerHTML = '<span class="badge bg-success">Checked In</span>';
                row.cells[4].innerHTML = new Date().toLocaleString();
            }
            
            const checkedInCount = parseInt(document.getElementById('checkedInCount').textContent) + 1;
            const notCheckedInCount = parseInt(document.getElementById('notCheckedInCount').textContent) - 1;
            document.getElementById('checkedInCount').textContent = checkedInCount;
            document.getElementById('notCheckedInCount').textContent = notCheckedInCount;
            
            const totalRegs = <%= event.registrations.length %>;
            const percentage = Math.round((checkedInCount / totalRegs) * 100);
            const progressBar = document.getElementById('attendanceProgress');
            progressBar.style.width = percentage + '%';
            progressBar.textContent = percentage + '%';
            
            document.getElementById('ticketToken').value = '';
        } else {
            messageDiv.innerHTML = `<div class="alert alert-warning"><strong>Error:</strong> ${data.message}</div>`;
        }
    } catch (error) {
        messageDiv.innerHTML = `<div class="alert alert-danger"><strong>Error:</strong> Failed to check in. Please try again.</div>`;
    }
});
</script>
